# Copyright (c) Huawei Technologies Co., Ltd. 2025. All rights reserved.
#
# This source file is part of the Cangjie project, licensed under Apache-2.0
# with Runtime Library Exception.
#
# See https://cangjie-lang.cn/pages/LICENSE for license information.

# Generate cpp code for syntax using flatc with cpp backend.
set(SCHEMA_SRC NodeFormat.fbs)
get_filename_component(FILENAME ${SCHEMA_SRC} NAME_WE)
set(FLATC_EXECUTABLE "${CMAKE_BINARY_DIR}/bin/flatc")
set(FLATBUFFER_SRC ${CMAKE_CURRENT_SOURCE_DIR}/../../../../third_party/flatbuffers)

# message(FATAL_ERROR "flatbuffer source: ${CMAKE_CURRENT_SOURCE_DIR}")

set(FLATC_CPP_OUTPUT "${CMAKE_BINARY_DIR}/include/flatbuffers/${FILENAME}_generated.h")
add_custom_command(
    OUTPUT ${FLATC_CPP_OUTPUT}
    COMMAND ${FLATC_EXECUTABLE} ARGS --no-warnings -c -o "${CMAKE_BINARY_DIR}/include/flatbuffers" ${SCHEMA_SRC}
    DEPENDS flatbuffers ${SCHEMA_SRC} # flatc defined in flatbuffers project: add_executable(flatc..)
    COMMENT "generate cpp file using flatc"
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})

# Generate cangjie code for syntax using flatc with cangjie backend.
set(FLATC_CJ_OUTPUT "${CMAKE_BINARY_DIR}/${FILENAME}_generated.cj")
set(FLATBUFFER_DEPEND_CJ_DIR ${FLATBUFFER_SRC}/cangjie)
add_custom_command(
    OUTPUT ${FLATC_CJ_OUTPUT}
    COMMAND ${FLATC_EXECUTABLE} ARGS --no-warnings --cangjie -o "${CMAKE_BINARY_DIR}" ${SCHEMA_SRC}
    DEPENDS flatbuffers ${SCHEMA_SRC} # flatc defined in flatbuffers project: add_executable(flatc..)

    COMMAND sed 's/std.ast/stdx.syntax/g' ${FLATBUFFER_DEPEND_CJ_DIR}/flatbuffer_object.cj > ${CMAKE_BINARY_DIR}/flatbuffer_object.cj
    COMMAND sed 's/std.ast/stdx.syntax/g' ${FLATBUFFER_DEPEND_CJ_DIR}/decode.cj > ${CMAKE_BINARY_DIR}/decode.cj
    COMMAND sed 's/std.ast/stdx.syntax/g' ${FLATBUFFER_DEPEND_CJ_DIR}/table.cj > ${CMAKE_BINARY_DIR}/table.cj
    COMMAND sed 's/std.ast/stdx.syntax/g' ${CMAKE_BINARY_DIR}/${FILENAME}_generated.cj > ${CMAKE_BINARY_DIR}/${FILENAME}_generated_update.cj
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_BINARY_DIR}/flatbuffer_object.cj
            ${CMAKE_SOURCE_DIR}/src/stdx/syntax/
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_BINARY_DIR}/decode.cj
            ${CMAKE_SOURCE_DIR}/src/stdx/syntax/
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_BINARY_DIR}/table.cj
            ${CMAKE_SOURCE_DIR}/src/stdx/syntax/
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_BINARY_DIR}/${FILENAME}_generated_update.cj
            ${CMAKE_SOURCE_DIR}/src/stdx/syntax/${FILENAME}_generated.cj
    COMMENT "generate cangjie file using flatc"

    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})

add_custom_target(FLATC_OUTPUTS ALL DEPENDS ${FLATC_CJ_OUTPUT} ${FLATC_CPP_OUTPUT})

# 1. æºæ–‡ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰
file(GLOB synatx_ffi_src
    AstApi.cpp
    NodeWriter.cpp
    ExprWriter.cpp
    TokenWriter.cpp
    ParserSyntax.cpp
    ParserSyntaxImpl.cpp
)

set(libname stdx.syntaxFFI)

# 2. æ”¹ä¸º STATIC åº“ï¼ˆä¸å†æ˜¯ SHAREDï¼‰
add_library(${libname} STATIC ${synatx_ffi_src})

# ä¸å†éœ€è¦ -fPIC å¼ºåˆ¶è®¾ç½®ï¼ˆé™æ€åº“é€šå¸¸ä¸éœ€è¦ï¼Œé™¤éè¢«ç”¨äº shared libï¼‰
# ä½†å¦‚æœåç»­ä¼šè¢«é“¾æ¥è¿› shared libï¼Œä¿ç•™ä¹Ÿæ— å¦¨
set_target_properties(${libname} PROPERTIES COMPILE_FLAGS "-fPIC")

# 3. ä¾èµ–ï¼ˆä¿æŒä¸å˜ï¼‰
add_dependencies(${libname} FLATC_OUTPUTS)

# 4. æŸ¥æ‰¾ Cangjie è·¯å¾„ï¼ˆä¿æŒä¸å˜ï¼‰
set(CANGJIE_INC_DIR)
set(AST_SUPPORT_LIB_DIR)
set(LSP_LIB_DIR)

if(DEFINED ENV{CANGJIE_HOME})
    if ("$ENV{CANGJIE_LSP_PATH}" STREQUAL "")
        set(LSP_LIB_DIR $ENV{CANGJIE_HOME}/tools/lib)
    else()
        set(LSP_LIB_DIR $ENV{CANGJIE_LSP_PATH})
    endif()
    string(TOLOWER ${TARGET_TRIPLE_DIRECTORY_PREFIX}_${CJNATIVE_BACKEND} output_cj_lib_dir)
    set(AST_SUPPORT_LIB_DIR $ENV{CANGJIE_HOME}/lib/${output_cj_lib_dir})
    set(CANGJIE_INC_DIR $ENV{CANGJIE_HOME}/include)
    if(NOT EXISTS "${CANGJIE_INC_DIR}/cangjie")
        # using local cangjie source
        set(CANGJIE_INC_DIR ~/dev/cangjie/cangjie/include)
        if(NOT EXISTS "${CANGJIE_INC_DIR}/cangjie")
            message(FATAL_ERROR "NOT FOUND CANGJIE HEADERS")
        endif()
    endif()
else()
    message(FATAL_ERROR "NOT FOUND CJC")
endif()

# 5. ç¼–è¯‘é€‰é¡¹å’Œå¤´æ–‡ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰
target_compile_options(${libname} PRIVATE ${CMAKE_C_COVERAGE_FLAGS})
target_include_directories(${libname} PRIVATE ${CANGJIE_INC_DIR} ${CMAKE_BINARY_DIR}/include)

if(CANGJIE_BUILD_STDLIB_WITH_COVERAGE)
    target_compile_options(${libname} PUBLIC "-fno-exceptions")
    target_compile_definitions(${libname} PRIVATE CANGJIE_ENABLE_GCOV)
endif()

# 6. ğŸ”¥ å…³é”®ï¼šåˆå¹¶ libcangjie-ast-support.a åˆ°é™æ€åº“ä¸­

# æ„å»º support.a çš„å®Œæ•´è·¯å¾„
string(TOLOWER ${TARGET_TRIPLE_DIRECTORY_PREFIX}_${CJNATIVE_BACKEND} output_cj_lib_dir)
set(AST_SUPPORT_LIB_PATH "${AST_SUPPORT_LIB_DIR}/libcangjie-ast-support.a")

if(NOT EXISTS "${AST_SUPPORT_LIB_PATH}")
    message(FATAL_ERROR "AST support library not found: ${AST_SUPPORT_LIB_PATH}")
endif()

# æ–¹æ³•ï¼šä½¿ç”¨è‡ªå®šä¹‰å‘½ä»¤åˆå¹¶ï¼ˆå…¼å®¹æ‰€æœ‰ CMake ç‰ˆæœ¬ï¼‰
set(MERGED_STATIC_LIB "${CMAKE_CURRENT_BINARY_DIR}/lib${libname}.a")

# è·å–å½“å‰åº“ç”Ÿæˆçš„ .a æ–‡ä»¶è·¯å¾„ï¼ˆCMake è‡ªåŠ¨ç”Ÿæˆï¼‰
get_target_property(ORIGINAL_STATIC_LIB ${libname} ARCHIVE_OUTPUT_NAME)
if(ORIGINAL_STATIC_LIB STREQUAL "ORIGINAL_STATIC_LIB-NOTFOUND")
    set(ORIGINAL_STATIC_LIB "lib${libname}.a")
endif()
set(ORIGINAL_STATIC_LIB_PATH "${CMAKE_CURRENT_BINARY_DIR}/${ORIGINAL_STATIC_LIB}")

# è‡ªå®šä¹‰åˆå¹¶å‘½ä»¤
add_custom_command(
    OUTPUT ${MERGED_STATIC_LIB}
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${AST_SUPPORT_LIB_PATH} ${MERGED_STATIC_LIB}
    COMMAND ar q ${MERGED_STATIC_LIB} ${ORIGINAL_STATIC_LIB_PATH}
    COMMAND ranlib ${MERGED_STATIC_LIB}
    DEPENDS ${libname} ${AST_SUPPORT_LIB_PATH}
    COMMENT "Merging libcangjie-ast-support.a into ${MERGED_STATIC_LIB}"
)

# åˆ›å»ºä¸€ä¸ª INTERFACE åº“ï¼Œä¾›å…¶ä»–ç›®æ ‡é“¾æ¥æœ€ç»ˆåˆå¹¶åçš„é™æ€åº“
add_library(${libname}_merged INTERFACE)
target_link_libraries(${libname}_merged INTERFACE ${MERGED_STATIC_LIB})

# 7. å®‰è£…è§„åˆ™ï¼ˆä½ å¯èƒ½éœ€è¦è°ƒæ•´ install_cangjie_library_ffi_sï¼‰
# å‡è®¾ install_cangjie_library_ffi_s å®‰è£…é™æ€åº“ï¼Œç°åœ¨åº”æŒ‡å‘ MERGED ç‰ˆæœ¬

# é‡å†™å®‰è£…é€»è¾‘ï¼ˆå¦‚æœåŸå‡½æ•°ä¸æ”¯æŒè‡ªå®šä¹‰è·¯å¾„ï¼‰
install(FILES ${MERGED_STATIC_LIB}
        DESTINATION lib
        RENAME lib${libname}.a)

# å¦‚æœä½ ä»æƒ³ä¿ç•™åŸæ¥çš„ install å‡½æ•°è°ƒç”¨ï¼Œå¯æ³¨é‡Šä¸Šé¢ installï¼Œå¹¶ä¿®æ”¹å‡½æ•°è¡Œä¸º
# ä½†æ›´å®‰å…¨çš„æ–¹å¼æ˜¯æ˜¾å¼å®‰è£… merged åº“